---

- name: Install apt-transport-https 
  apt: 
    name: apt-transport-https
    state: present
    update_cache: yes

- name: Add tine20 repo
  apt_repository:
    repo: "deb https://packages.tine20.org/{{ ansible_distribution|lower }} {{ ansible_distribution_release }} stable"
    state: present
    update_cache: yes

- name: apt-key
  apt_key:
    keyserver: keys.gnupg.net
    id: 8825FD82
    state: present

- name: Get tine20
  apt:
    name: tine20
    state: latest
    force: yes

- name: Enable https
  apache2_module:
    state: present
    name: ssl
    ignore_configcheck: True
  notify:
    - Restart apache2
  ignore_errors: true

- name: Run all handlers before installing tine20
  meta: flush_handlers

- name: Create log dir with permissions
  file:
    name: "/var/log/tine20"
    state: directory
    mode: 0750
    owner: www-data
    group: root

- name: Install tine20
  shell: |
   php /usr/share/tine20/setup.php -c /etc/tine20 --install -- adminLoginName={{ tine20_admin_name }} adminPassword={{ tine20_admin_passwd }} acceptedTermsVersion=1000 adminEmailAddress={{ tine20_admin_name }}@{{ emaildomain }} imap=host:{{ tine20_mailhost }},port:143,useSystemAccount:1,domain:{{ domain }},ssl:none,useEmailAsUsername:0,backend:dovecot_imap,dovecot_host:{{ dbhost }},dovecot_dbname:dovecot,dovecot_username:{{ mailserver_db_user_name }},dovecot_password:{{ mailserver_db_user_passwd }},dovecot_uid:{{ deliver_user_name }},dovecot_gid:{{ deliver_user_name }},dovecot_home:/var/spool/mail/%d/%n,dovecot_scheme:SSHA512 smtp='{"active":true,"backend":"postfix","hostname":"{{ tine20_mailhost }}","port":25,"ssl":"none","auth":"none","primarydomain":"{{ domain }}","secondarydomains":"{{ email_domains_csv }}","username":"tine20@{{ domain }}","password":"tine20","from":"tine20@{{ domain }}","postfix":{"host":"{{ dbhost }}","dbname":"postfix","username":"{{ mailserver_db_user_name }}","password":"{{ mailserver_db_user_passwd }}"} }' sieve=hostname:{{ tine20_mailhost }},port:4190,ssl:tls
  args:
    executable: "/bin/bash"
  become: True
  become_user: "www-data"
  notify:
    - Restart apache2

- name: Update tine20
  shell: 'php /usr/share/tine20/setup.php -c /etc/tine20 --update'
  args:
    executable: "/bin/bash"
  become: True
  become_user: "www-data"
  notify:
    - Restart apache2

- name: Set log file permissions
  file:
    name: "/var/log/tine20/tine20.log"
    state: file
    mode: 0644
    owner: www-data
    group: www-data

- name: TLS required
  blockinfile:
    path: /etc/tine20/apache.conf
    marker: "# {mark} Ansible crm/tine https config for {{ item }}"
    content: | 
      <VirtualHost *:80>
        ServerName   {{ item }}
        Redirect permanent /tine20 https://{{ item }}/tine20
      </VirtualHost>

      <VirtualHost *:443>
        SSLEngine on
        SSLCertificateFile {{ certbaselocation }}/{{ item }}/fullchain.pem
        SSLCertificateKeyFile {{ certbaselocation }}/{{ item }}/privkey.pem
        DocumentRoot /usr/share/tine20
        ServerName   {{ item }}
      </VirtualHost>
  with_items:
    - "{{ domain }}"
    - "{{ secondarydomains }}"
  notify:
    - Restart apache2







